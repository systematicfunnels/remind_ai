// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ReminderStatus {
  pending
  done
  cancelled
  failed
}

enum RecurrenceRule {
  none
  daily
  weekly
  monthly
}

enum UserRole {
  user
  admin
}

model User {
  id             String     @id @default(uuid()) @db.Uuid
  phone_id       String     @unique
  role           UserRole   @default(user)
  channel        String?    @default("unknown")
  sub_status     String?    @default("trial")
  is_blocked     Boolean?   @default(false)
  reminder_count Int?       @default(0)
  timezone       String?    @default("UTC")
  last_active_at DateTime?  @default(now()) @db.Timestamp(6)
  payment_id     String?
  created_at     DateTime?  @default(now()) @db.Timestamp(6)
  is_erased      Boolean?   @default(false)
  reminders      Reminder[]

  @@map("users")
  @@index([phone_id])
}

model Reminder {
  id             String         @id @default(uuid()) @db.Uuid
  user_id        String?        @db.Uuid
  task           String
  scheduled_at   DateTime       @db.Timestamptz(6)
  status         ReminderStatus @default(pending)
  recurrence     RecurrenceRule @default(none)
  failure_reason String?
  done_at        DateTime?      @db.Timestamp(6)
  created_at     DateTime?      @default(now()) @db.Timestamp(6)
  user           User?          @relation(fields: [user_id], references: [id])

  @@map("reminders")
  @@index([user_id, status])
  @@index([scheduled_at])
}

model LoginAttempt {
  id         String   @id @default(uuid()) @db.Uuid
  ip_address String
  attempts   Int      @default(1)
  last_tried DateTime @default(now()) @db.Timestamp(6)

  @@map("login_attempts")
  @@index([ip_address])
}
